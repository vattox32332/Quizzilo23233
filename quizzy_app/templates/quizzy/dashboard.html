<!DOCTYPE html>
<html lang="en" >

<head>
  <meta charset="UTF-8">

  {% load static %}

  <title>Quizzilo - Dashboard</title>

  <link rel="icon" type="image/png" href="{% static 'media/logo.ico' %}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css'>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" type="text/css" href="{% static 'css/dashboard.css' %}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    window.console = window.console || function(t) {};
  </script>

</head>

<body translate="no">

<div class="bank-overflow"></div>

  <!-- overlay -->
<div id="sidebar-overlay" class="overlay w-100 vh-100 position-fixed d-none"></div>

<!-- sidebar -->
<div class="col-md-3 col-lg-2 px-0 position-fixed h-100 bg-white shadow-sm sidebar" id="sidebar">
  <div class="bank-overflow"></div>
  <img style="height: 100px; margin: auto; display: block;" src="{% static 'media/logo.ico' %}">
  <div class="list-group rounded-0">

    <a href="#" class="list-group-item list-group-item-action active border-0 d-flex align-items-center">
      <span class="bi bi-border-all"></span>
      <span class="ml-2">Dashboard</span>
    </a>
    <a href="#" class="open-modal list-group-item list-group-item-action border-0 align-items-center">
      <span class="bi bi-plus"></span>
      <span class="ml-2">New quiz</span>
    </a>

    {% if Active == False %}

    <button class="list-group-item list-group-item-action border-0 d-flex justify-content-between align-items-center" data-toggle="collapse" data-target="#purchase-collapse">
      <div>
        <span class="bi bi-award"></span>
        <span class="ml-2">Upgrade</span>
      </div>
      <span class="bi bi-chevron-down small"></span>
    </button>
    <div class="collapse" id="purchase-collapse" data-parent="#sidebar">
      <div class="list-group">
        <a href="pricing" class="list-group-item list-group-item-action border-0 pl-5">1 month</a>
        <a href="pricing" class="list-group-item list-group-item-action border-0 pl-5">6 month</a>
        <a href="pricing" class="list-group-item list-group-item-action border-0 pl-5">12 month</a>
      </div>
    </div>

    {%endif%}

  </div>
</div>

<div class="col-md-9 col-lg-10 ml-md-auto px-0 ms-md-auto">
  <!-- top nav -->
  <nav class="w-100 d-flex px-4 py-2 mb-4 shadow-sm">
    <!-- close sidebar -->
    <button class="btn py-0 d-lg-none" id="open-sidebar">
      <span class="bi bi-list text-primary h3"></span>
    </button>
    <div class="dropdown ml-auto">
      <button class="btn py-0 d-flex align-items-center" id="logout-dropdown" data-toggle="dropdown" aria-expanded="false">
        <span class="bi bi-person text-primary h4"></span>
        <span class="bi bi-chevron-down ml-1 mb-2 small"></span>
      </button>
      <div class="dropdown-menu dropdown-menu-right border-0 shadow-sm" aria-labelledby="logout-dropdown">
        <a class="dropdown-item" href="/accounts/logout/">Logout</a>
        <a class="dropdown-item" href="/accounts/">Settings</a>
      </div>
    </div>
  </nav>

  <!-- main content -->
  <main class="p-4 min-vh-100">


    <div class="bank-manager-container" id="file-explorer">
      <div id="navigation">
          <button id="back-btn" disabled>‚Üê</button>
          <button id="forward-btn" disabled>‚Üí</button>
          <div style="display: none;" class="status_loader">
            <div class="custom-loader-3"></div>
          </div>
      </div>
      <div id="path-bar">/</div>
      <div id="file-list"></div>
      <div class="bottom-bank-div">
        <button class="myquiz-button3" onclick="openSharingModal()"> Share </button>
        <button style="margin: 10px; height: 40px; width: 60px; border-radius: 10px; color: white; background-color: #007bff; text-align:center;" onclick="Close_bank()">
          close
        </button>
      </div>
    </div>
    <div id="context-menu">
      <div id="create-folder">New Folder</div>
      <div id="create-file">New File</div>
    </div>

    <script>

      $(document).ready(function() {

          function getCSRFToken() {
              var csrfToken = null;
              document.cookie.split(';').forEach(function(cookie) {
                  var parts = cookie.split('=');
                  if (parts[0].trim() == 'csrftoken') {
                  csrfToken = parts[1].trim();
                  }
              });
              return csrfToken;
          }

          const fileSystem = {{ Tree_JSON|safe }};

          let currentPath = '/';
          let navigationHistory = ['/'];
          let currentHistoryIndex = 0;
          let draggedItem = null;
          let selectedItem = null;
          let contextMenuTimeout;

          function renderFiles() {
              const $fileList = $('#file-list');
              $fileList.empty();

              const currentFolder = getCurrentFolder();
              Object.keys(currentFolder.children).forEach(name => {
                  const item = currentFolder.children[name];
                  const $item = $(`
                      <div class="file-item" 
                              data-id="${item.id}"
                              data-name="${name}" 
                              data-type="${item.type}"
                              ${item.locked ? 'data-locked="true"' : ''}
                              draggable="true">
                          <span class="file-icon">${item.type === 'folder' ? 'üìÅ' : 'üìÑ'}</span>
                          <span class="file-name" ${item.locked ? 'style="color:red;"' : ''}>${item.type === 'folder' ? name : `<a target="_blank" href=https://www.quizzilo.com/bridge?id=${item.id}>${name}</a>`}</span>
                      </div>
                  `);
                  $fileList.append($item);
              });

              setupDragAndDrop();
              updatePathBar();
              updateNavigationButtons();
              setupContextMenu();
          }

function setupDragAndDrop() {
    let draggedItem = null;
    let touchStartElement = null;
    let isDragging = false;

    // Common function to handle drag start
    function handleDragStart(element) {
        draggedItem = {
            id: $(element).data('id'),
            name: $(element).data('name'),
            type: $(element).data('type')
        };
        isDragging = true;
    }

    // Common function to handle drag over
    function handleDragOver(element) {
        const targetType = $(element).data('type');
        if (targetType === 'folder') {
            $(element).addClass('drag-over');
        }
    }

    // Common function to handle drag leave
    function handleDragLeave(element) {
        $(element).removeClass('drag-over');
    }

    // Common function to handle drop
    function handleDrop(element) {
        $(element).removeClass('drag-over');

        const targetId = $(element).data('id');
        const targetName = $(element).data('name');
        const targetType = $(element).data('type');

        // Prevent dragging a folder into itself
        if (draggedItem && draggedItem.id === targetId) {
            console.log("Cannot drag a folder into itself.");
            return; // Exit the function early
        }

        // Only allow dropping into folders
        if (targetType === 'folder' && draggedItem) {
            const currentFolder = getCurrentFolder();
            const targetFolder = currentFolder.children[targetName];

            $('.status_loader').css('display', 'block');

            if (draggedItem.type === 'folder') {
                $.ajax({
                    url: window.location.href,
                    method: "POST",
                    data: { New_parent: targetId, Folder_draged_id: draggedItem.id, isFile: "0" },
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });
            } else {
                $.ajax({
                    url: window.location.href,
                    method: "POST",
                    data: { New_parent: targetId, Folder_draged_id: draggedItem.id, isFile: "1" },
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });
            }

            // Move the dragged item
            targetFolder.children[draggedItem.name] = currentFolder.children[draggedItem.name];

            // Remove from original location
            delete currentFolder.children[draggedItem.name];

            renderFiles();
            draggedItem = null;
            $('.status_loader').css('display', 'none');
        }
    }

    // Desktop events
    $('.file-item').on('dragstart', function(e) {
        handleDragStart(this);
        e.originalEvent.dataTransfer.setData('text/plain', '');
    });

    $('.file-item').on('dragover', function(e) {
        e.preventDefault();
        handleDragOver(this);
    });

    $('.file-item').on('dragleave', function() {
        handleDragLeave(this);
    });

    $('.file-item').on('drop', function(e) {
        e.preventDefault();
        handleDrop(this);
    });

    // Mobile touch events
    $('.file-item').on('touchstart', function(e) {
        touchStartElement = this;
        handleDragStart(this);
    });

    $('.file-item').on('touchmove', function(e) {
        if (isDragging && touchStartElement) {
            e.preventDefault(); // Prevent scrolling while dragging
            const touch = e.originalEvent.touches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);

            // Remove drag-over class from all elements
            $('.file-item').removeClass('drag-over');

            // Add drag-over class to the element under the touch point
            if (element && $(element).hasClass('file-item')) {
                handleDragOver(element);
            }
        }
    });

    $('.file-item').on('touchend', function(e) {
        if (isDragging && touchStartElement) {
            const touch = e.originalEvent.changedTouches[0];
            const element = document.elementFromPoint(touch.clientX, touch.clientY);

            if (element && $(element).hasClass('file-item')) {
                handleDrop(element);
            }

            // Clean up
            $('.file-item').removeClass('drag-over');
            isDragging = false;
            touchStartElement = null;
            draggedItem = null;
        }
    });

    $('.file-item').on('touchcancel', function() {
        if (isDragging) {
            $('.file-item').removeClass('drag-over');
            isDragging = false;
            touchStartElement = null;
            draggedItem = null;
        }
    });
}

          function getCurrentFolder() {
              let folder = fileSystem['/'];
              const pathParts = currentPath.split('/').filter(p => p);

              for (let part of pathParts) {
                  folder = folder.children[part];
              }
              return folder;
          }

          function updatePathBar() {
              $('#path-bar').text(currentPath);
          }

          function updateNavigationButtons() {
              $('#back-btn').prop('disabled', currentHistoryIndex <= 0);
              $('#forward-btn').prop('disabled', currentHistoryIndex >= navigationHistory.length - 1);
          }

          function setupContextMenu() {
              $('#file-explorer').off('contextmenu').on('contextmenu', function(e) {
                  e.preventDefault();
                  const $target = $(e.target).closest('.file-item');
                  const $contextMenu = $('#context-menu');

                  // Clear previous context menu
                  $contextMenu.empty();

                  if ($target.length) {
                      // Right-click on a file/folder
                      selectedItem = {
                          id: $target.data('id'),
                          name: $target.data('name'),
                          type: $target.data('type'),
                      };

                      // Move option for both files and folders
                      $contextMenu.append($('<div>', {
                          id: 'move-item',
                          text: 'Move',
                          click: moveItem
                      }));

                      // Additional options for folders
                      if (selectedItem.type === 'folder') {
                          // Rename option
                          $contextMenu.append($('<div>', {
                              id: 'rename-item',
                              text: 'Rename',
                              click: renameItem
                          }));

                          // Delete option
                          $contextMenu.append($('<div>', {
                              id: 'delete-item',
                              text: 'Delete',
                              click: deleteItem
                          }));
                      }
                  } else {
                      // Right-click on blank space
                      selectedItem = null;

                      // Create folder option
                      $contextMenu.append($('<div>', {
                          id: 'create-folder',
                          text: 'New Folder',
                          click: createFolder
                      }));

                      // Create file option
                      $contextMenu.append($('<div>', {
                          id: 'create-file',
                          text: 'New File',
                          click: createFile
                      }));
                  }

                  // Position and show context menu
                  $contextMenu.css({
                      display: 'block',
                      left: (e.clientX + 5) + 'px',
                      top: (e.clientY + 5) + 'px'
                  });

                  // Hide after 3 seconds
                  clearTimeout(contextMenuTimeout);
                  contextMenuTimeout = setTimeout(() => {
                      $contextMenu.hide();
                  }, 3000);
              });

              // Hide context menu when clicking elsewhere
              $(document).click(function(e) {
                  if (!$(e.target).closest('#context-menu, #file-explorer').length) {
                      $('#context-menu').hide();
                  }
              });
          }

          function moveItem() {
    if (!selectedItem) return;

    // Check if the item is already in root directory
    const isInRoot = getCurrentFolder() === fileSystem['/'];

    // Create a modal or dialog to show folder structure
    const $moveDialog = $('<div>', { id: 'move-dialog', class: 'modal' });
    const $folderTree = $('<div>', { id: 'folder-tree' });

    // Add root folder option with disabled state if item is already in root
    const $rootFolder = $('<div>', {
        class: `root-folder${isInRoot ? ' disabled' : ''}`,
        text: 'Root Directory',
        'data-id': 'root',
        'data-path': '/'
    });

    // Only add click handler if item is not already in root
    if (!isInRoot) {
        $rootFolder.click(function() {
            handleMove('root', '/');
        });
    }

    // Rest of your code remains the same...
    function handleMove(targetId, targetPath) {
        if (confirm(`Move ${selectedItem.name} to ${targetPath}?`)) {
            $('.status_loader').css('display', 'block');

            $.ajax({
                url: window.location.href,
                method: "POST",
                data: { 
                    New_parent: targetId, 
                    Folder_draged_id: selectedItem.id, 
                    isFile: selectedItem.type === 'file' ? "1" : "0" 
                },
                headers: {
                    'X-CSRFToken': getCSRFToken()
                },
                success: function() {
                    const currentFolder = getCurrentFolder();
                    const targetFolder = targetPath === '/' ? fileSystem['/'] : getFolder(targetPath);

                    // Move item in file system
                    targetFolder.children[selectedItem.name] = 
                        currentFolder.children[selectedItem.name];
                    delete currentFolder.children[selectedItem.name];

                    renderFiles();
                    $('.status_loader').css('display', 'none');
                    $moveDialog.remove();
                }
            });
        }
    }

                  // Recursive function to build folder tree
                  function buildFolderTree(folder, path = '/') {
                    const $folderList = $('<ul>');

                    Object.keys(folder.children).forEach(name => {
                        const item = folder.children[name];
                        if (item.type === 'folder') {
                            // Check if the current folder is the selected item or a subfolder of the selected item
                            const isCurrentFolderOrSubfolder = 
                                (selectedItem.name === name) || 
                                (selectedItem.type === 'folder' && path.includes(`/${selectedItem.name}/`));

                            const $folderItem = $('<li>', {
                                'data-id': item.id,
                                'data-path': path + name + '/',
                                text: name,
                                class: isCurrentFolderOrSubfolder ? 'disabled' : ''
                            });

                            if (!isCurrentFolderOrSubfolder) {
                                $folderItem.click(function(e) {
                                    e.stopPropagation(); // Prevent event bubbling
                                    const targetId = $(this).data('id');
                                    const targetPath = $(this).data('path');
                                    handleMove(targetId, targetPath);
                                });
                            }

                            // Recursively build subfolders
                            const $subfolders = buildFolderTree(item, path + name + '/');
                            $folderItem.append($subfolders);
                            $folderList.append($folderItem);
                        }
                    });

                    return $folderList;
                }

                // Function to get folder by path
                function getFolder(path) {
                    let folder = fileSystem['/'];
                    const pathParts = path.split('/').filter(p => p);

                    for (let part of pathParts) {
                        folder = folder.children[part];
                    }
                    return folder;
                }

                // Build and display folder tree
                const rootTree = buildFolderTree(fileSystem['/']);
                $folderTree.append($rootFolder);
                $folderTree.append(rootTree);
                $moveDialog.append($('<h3>Select Destination Folder</h3>'));
                $moveDialog.append($folderTree);

    // Update the CSS to style the disabled root folder
    $('<style>')
        .prop('type', 'text/css')
        .html(`
            #folder-tree .disabled {
                color: #888;
                cursor: not-allowed;
            }
            #folder-tree .disabled:hover {
                background: none;
            }
            .root-folder {
                padding: 5px;
                cursor: pointer;
            }
            .root-folder:hover {
                background-color: #f0f0f0;
            }
            .root-folder.disabled {
                color: #888;
                cursor: not-allowed;
            }
            .root-folder.disabled:hover {
                background: none;
            }
        `)
        .appendTo('head');

        // Add cancel button
        const $cancelBtn = $('<button>', {
            text: 'Cancel',
            click: function() { $moveDialog.remove(); }
        });
        $moveDialog.append($cancelBtn);

        // Append to body
        $('body').append($moveDialog);

        $('#context-menu').hide();
    }

function renameItem() {
    if (!selectedItem) return;

    const currentFolder = getCurrentFolder();
    const oldName = selectedItem.name;
    const newName = prompt(`Enter new name for ${oldName}:`);

    if (newName && newName !== oldName) {
        // Check if the new name exists anywhere in the file system
        function isNameExists(obj) {
            for (let key in obj.children) {
                if (key === newName) return true;
                if (obj.children[key].type === 'folder' && 
                    obj.children[key].children && 
                    isNameExists(obj.children[key])) return true;
            }
            return false;
        }

        // Start checking from root
        if (isNameExists(fileSystem['/'])) {
            alert('A folder with this name already exists in the file system.');
            return;
        }

        $('.status_loader').css('display', 'block');

        $.ajax({
            url: window.location.href,
            method: "POST",
            data: { Folder_New_Name: newName, Folder_to_change_id: selectedItem.id },
            headers: {
                'X-CSRFToken': getCSRFToken()
            }
        });

        // Rename the item
        currentFolder.children[newName] = currentFolder.children[oldName];
        delete currentFolder.children[oldName];

        renderFiles();
    }
    $('.status_loader').css('display', 'none');
    $('#context-menu').hide();
}

          function deleteItem() {
              if (!selectedItem) return;

              const confirmDelete = confirm(`Are you sure you want to delete ${selectedItem.name}?`);
              if (confirmDelete) {
                  const currentFolder = getCurrentFolder();
                  delete currentFolder.children[selectedItem.name];

                  $('.status_loader').css('display', 'block');

                  $.ajax({
                      url: window.location.href,
                      method: "POST",
                      data: { Folder_to_Delete : selectedItem.id },
                      headers: {
                          'X-CSRFToken': getCSRFToken()
                      }
                  });

                  renderFiles();
              }
              $('.status_loader').css('display', 'none');
              $('#context-menu').hide();
          }

          function generateGloballyUniqueName(name, fileSystem) {
          let uniqueName = name;
          let counter = 1;

          // Recursive function to check name existence in entire file system
          function isNameExists(obj) {
              for (let key in obj.children) {
                  if (key === uniqueName) return true;
                  if (obj.children[key].type === 'folder' && 
                      obj.children[key].children && 
                      isNameExists(obj.children[key])) return true;
              }
              return false;
          }

          // Check name existence starting from root
          while (isNameExists(fileSystem['/'])) {
              uniqueName = `${name} (${counter})`;
              counter++;
          }

          return uniqueName;
      }

      function createFolder() {
          const currentFolder = getCurrentFolder();
          let folderName = prompt('Enter folder name:');
          if (folderName) {
              // Generate globally unique name
              const uniqueFolderName = generateGloballyUniqueName(folderName, fileSystem);

              $('.status_loader').css('display', 'block');

              $.ajax({
                  url: window.location.href,
                  method: "POST",
                  data: { 
                      Folder_Name: uniqueFolderName, 
                      Parent_Id: currentFolder.id 
                  },
                  headers: {
                      'X-CSRFToken': getCSRFToken()
                  },
                  success: function(response) {
                      if ('New_Folder' in response) {
                          currentFolder.children[uniqueFolderName] = {
                              type: 'folder',
                              id: response.New_Folder,
                              children: {}
                          };
                          renderFiles();
                          $('.status_loader').css('display', 'none');
                      }
                  }
              });
          }
          $('#context-menu').hide();
      }

      function createFile() {
          const currentFolder = getCurrentFolder();
          let fileName = prompt('Enter file name:');
          if (fileName) {
              // Generate globally unique name
              const uniqueFileName = generateGloballyUniqueName(fileName, fileSystem);

              $('.status_loader').css('display', 'block');

              $.ajax({
                  url: window.location.href,
                  method: "POST",
                  data: { 
                      New_Quizz_Title: uniqueFileName, 
                      Parent_Quizz_Folder: currentFolder.id 
                  },
                  headers: {
                      'X-CSRFToken': getCSRFToken()
                  },
                  success: function(response) {
                      if ('URL' in response) {
                          currentFolder.children[uniqueFileName] = {
                              type: 'file',
                              id: response.ID
                          };
                          renderFiles();
                          $('.status_loader').css('display', 'none');
                      } else {
                          window.location.href = "/pricing";
                      }
                  }
              });
          }
          $('#context-menu').hide();
      }

          $(document).on('click', '.file-item', function() {
              const name = $(this).data('name');
              const type = $(this).data('type');

              if (type === 'folder') {
                  currentPath = currentPath.endsWith('/') ? currentPath + name : currentPath + '/' + name;
                  navigationHistory = navigationHistory.slice(0, currentHistoryIndex + 1);
                  navigationHistory.push(currentPath);
                  currentHistoryIndex++;
                  renderFiles();
              }
          });

          $('#back-btn').click(function() {
              if (currentHistoryIndex > 0) {
                  currentHistoryIndex--;
                  currentPath = navigationHistory[currentHistoryIndex];
                  renderFiles();
              }
          });

          $('#forward-btn').click(function() {
              if (currentHistoryIndex < navigationHistory.length - 1) {
                  currentHistoryIndex++;
                  currentPath = navigationHistory[currentHistoryIndex];
                  renderFiles();
              }
          });

          renderFiles();

          // Sharing Modal Functions
          let selectedSharingPath = '/';
          let selectedSharingFolderId = 'root';

          // Make functions global by attaching to window
          window.openSharingModal = function() {
              document.getElementById('sharing-modal').style.display = 'flex';
              selectedSharingPath = currentPath;
              const currentFolder = getCurrentFolder();
              selectedSharingFolderId = currentFolder.id || 'root';
              document.getElementById('selected-path-text').textContent = currentPath;
              buildPathBrowser();
          };

          window.closeSharingModal = function() {
              document.getElementById('sharing-modal').style.display = 'none';
              document.getElementById('path-browser').style.display = 'none';
              document.getElementById('share-link-input').value = '';
          };

          window.togglePathBrowser = function() {
              const browser = document.getElementById('path-browser');
              browser.style.display = browser.style.display === 'none' ? 'block' : 'none';
          };

          function buildPathBrowser() {
              const browserContent = document.getElementById('path-browser-content');
              browserContent.innerHTML = '';

              // Add root option
              const rootOption = document.createElement('div');
              rootOption.className = 'path-browser-item';
              rootOption.innerHTML = `
                  <span class="path-icon">üè†</span>
                  <span class="path-name">Root Directory (/)</span>
              `;
              rootOption.onclick = () => selectSharingPath('/', 'root');
              browserContent.appendChild(rootOption);

              // Build folder tree
              function buildFolderOptions(folder, path = '/', level = 0) {
                  Object.keys(folder.children).forEach(name => {
                      const item = folder.children[name];
                      if (item.type === 'folder') {
                          const option = document.createElement('div');
                          option.className = 'path-browser-item';
                          option.style.paddingLeft = `${20 + (level * 20)}px`;
                          option.innerHTML = `
                              <span class="path-icon">üìÅ</span>
                              <span class="path-name">${name}</span>
                          `;
                          const folderPath = path.endsWith('/') ? path + name : path + '/' + name;
                          option.onclick = () => selectSharingPath(folderPath, item.id);
                          browserContent.appendChild(option);

                          // Recursively add subfolders
                          buildFolderOptions(item, folderPath, level + 1);
                      }
                  });
              }

              buildFolderOptions(fileSystem['/']);
          }

          function selectSharingPath(path, folderId) {
              selectedSharingPath = path;
              selectedSharingFolderId = folderId;
              document.getElementById('selected-path-text').textContent = path;
              document.getElementById('path-browser').style.display = 'none';
          }

          window.generateShareLink = function() {
              const permission = document.querySelector('input[name="permission"]:checked').value;
              const allowEdit = permission === 'edit';

              // Create share link with parameters
              const baseUrl = 'https://quizzilo.com/mytree';
              const params = new URLSearchParams({
                  session: '{{Tree_Key}}',
                  path: selectedSharingPath,
                  folderId: selectedSharingFolderId,
                  allowEdit: allowEdit ? '1' : '0'
              });

              const shareLink = `${baseUrl}?${params.toString()}`;
              document.getElementById('share-link-input').value = shareLink;
          };

          window.copyShareLink = function(event) {
              const input = document.getElementById('share-link-input');
              if (input.value) {
                  navigator.clipboard.writeText(input.value).then(() => {
                      // Show success feedback
                      const btn = event.target;
                      const originalText = btn.textContent;
                      btn.textContent = 'Copied!';
                      btn.style.backgroundColor = '#28a745';
                      setTimeout(() => {
                          btn.textContent = originalText;
                          btn.style.backgroundColor = '';
                      }, 2000);
                  });
              } else {
                  alert('Please generate a link first');
              }
          };

          window.copyQuizLink = function(url, event) {
              navigator.clipboard.writeText(url).then(() => {
                  // Show success feedback
                  const btn = event.target;
                  const originalText = btn.textContent;
                  btn.textContent = 'Copied!';
                  btn.style.backgroundColor = '#28a745';
                  setTimeout(() => {
                      btn.textContent = originalText;
                      btn.style.backgroundColor = '';
                  }, 2000);
              }).catch(() => {
                  // Fallback for older browsers
                  const textArea = document.createElement('textarea');
                  textArea.value = url;
                  document.body.appendChild(textArea);
                  textArea.select();
                  document.execCommand('copy');
                  document.body.removeChild(textArea);

                  const btn = event.target;
                  const originalText = btn.textContent;
                  btn.textContent = 'Copied!';
                  btn.style.backgroundColor = '#28a745';
                  setTimeout(() => {
                      btn.textContent = originalText;
                      btn.style.backgroundColor = '';
                  }, 2000);
              });
          };

          // RestrictShare function similar to Restrict_Quizz
          window.RestrictShare = function() {
              var Restricted = $("#inpShareLock").prop('checked');
              
              if (Restricted == true) {
                  // Get the input value
                  var new_share_password = prompt('Enter a password');

                  // Check if user canceled the prompt
                  if (new_share_password === null) {
                      // Uncheck the checkbox and notify the user
                      $('#inpShareLock').prop('checked', false);
                      return; // Exit the function
                  }

                  // Send an AJAX request to the same URL with CSRF token
                  if (new_share_password !== '') {
                      
                      // Send an AJAX request to the same URL with CSRF token
                      $.ajax({
                          url: window.location.href,
                          method: "POST",
                          data: { share_password: new_share_password},
                          headers: {
                              'X-CSRFToken': getCSRFToken()
                          },
                          success: function(response) { 

                              if ('status' in response && response.status === 'share_password_set') {

                                  $('#inpShareLock').prop('checked', true);
                                  alert('Share access locked')

                              }

                          }

                      });

                  } else {

                      $('#inpShareLock').prop('checked', false);
                      alert('Please enter a valid password.')

                  }

              } else {

                  // Send an AJAX request to the same URL with CSRF token
                  $.ajax({
                      url: window.location.href,
                      method: "POST",
                      data: { remove_share_password: 'true'},
                      headers: {
                          'X-CSRFToken': getCSRFToken()
                      },
                      success: function(response) { 

                          if ('status' in response && response.status === 'share_password_removed') {

                              $('#inpShareLock').prop('checked', false);
                              alert('Share access unlocked.')

                          }

                      }

                  });

              }
          };

      });

    </script>

<style>
.sharing-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
}

.sharing-modal-content {
    background-color: white;
    margin: auto;
    padding: 0;
    border-radius: 10px;
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.sharing-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 1px solid #ddd;
}

.sharing-modal-header h2 {
    margin: 0;
    color: #333;
}

.sharing-modal-close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.sharing-modal-close:hover {
    color: #000;
}

.sharing-modal-body {
    padding: 20px;
}

.sharing-section {
    margin-bottom: 25px;
}

.sharing-section h3 {
    margin-bottom: 15px;
    color: #333;
    font-size: 18px;
}

.path-selector {
    border: 1px solid #ddd;
    border-radius: 5px;
    overflow: hidden;
}

.current-path-display {
    display: flex;
    align-items: center;
    padding: 10px;
    background-color: #f8f9fa;
    border-bottom: 1px solid #ddd;
}

.path-icon {
    margin-right: 8px;
}

.browse-path-btn {
    margin-left: auto;
    background: #007bff;
    color: white;
    border: none;
    padding: 5px 10px;
    border-radius: 3px;
    cursor: pointer;
}

.path-browser {
    max-height: 200px;
    overflow-y: auto;
}

.path-browser-header {
    padding: 10px;
    background-color: #e9ecef;
    font-weight: bold;
}

.path-browser-content {
    padding: 0;
}

.path-browser-item {
    padding: 8px 15px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
}

.path-browser-item:hover {
    background-color: #f8f9fa;
}

.permission-options {
    display: flex;
    flex-direction: column;
    gap: 15px;
}

.permission-option {
    display: flex;
    align-items: flex-start;
    cursor: pointer;
    padding: 15px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: border-color 0.3s;
}

.permission-option:hover {
    border-color: #007bff;
}

.permission-option input[type="radio"] {
    margin-right: 10px;
    margin-top: 2px;
}

.permission-icon {
    font-size: 24px;
    margin-right: 10px;
}

.permission-details h4 {
    margin: 0 0 5px 0;
    color: #333;
}

.permission-details p {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.share-link-container {
    display: flex;
    gap: 10px;
}

.share-link-container input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
}

.copy-link-btn {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    cursor: pointer;
}

.sharing-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    padding: 20px;
    border-top: 1px solid #ddd;
}

.btn-generate {
    background: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.btn-cancel {
    background: #6c757d;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
}

.btn-cancel:hover {
  background-color: #545b62;
}

.btn-lock {
  display: inline-block;
  background: #ff5b5b;
  width: 64px;
  height: 64px;
  box-sizing: border-box;
  padding: 10px;
  border-radius: 50%;
  cursor: pointer;
  -webkit-tap-highlight-color: transparent;
}

.btn-lock svg {
  fill: none;
  transform: translate3d(0, 0, 0);
}

.btn-lock svg .bling {
  stroke: #fff;
  stroke-width: 2.5;
  stroke-linecap: round;
  stroke-dasharray: 3;
  stroke-dashoffset: 15;
  transition: all 0.3s ease;
}

.btn-lock svg .lock {
  stroke: #fff;
  stroke-width: 4;
  stroke-linejoin: round;
  stroke-linecap: round;
  stroke-dasharray: 36;
  transition: all 0.4s ease;
}

.btn-lock svg .lockb {
  fill: #fff;
  fill-rule: evenodd;
  clip-rule: evenodd;
  transform: rotate(8deg);
  transform-origin: 14px 20px;
  transition: all 0.2s ease;
}

#inpShareLock {
  display: none;
}

#inpShareLock:checked + label {
  background: #20cca5;
}

#inpShareLock:checked + label svg {
  opacity: 1;
}

#inpShareLock:checked + label svg .bling {
  animation: bling6132 0.3s linear forwards;
  animation-delay: 0.2s;
}

#inpShareLock:checked + label svg .lock {
  stroke-dasharray: 48;
  animation: locked 0.3s linear forwards;
}

#inpShareLock:checked + label svg .lockb {
  transform: rotate(0);
  transform-origin: 14px 22px;
}

@keyframes bling6132 {
  50% {
    stroke-dasharray: 3;
    stroke-dashoffset: 12;
  }

  100% {
    stroke-dasharray: 3;
    stroke-dashoffset: 9;
  }
}

@keyframes locked {
  50% {
    transform: translateY(1px);
  }
}
</style>

    <section class="row">

      <div class="col-md-6 col-lg-4">
        <!-- card -->
        <article class="p-4 rounded shadow-sm border-left
       mb-4">
          <a class="open-modal d-flex align-items-center">
            <span class="bi bi-plus-lg h1"></span>
            <h5 class="ml-2">New quiz</h5>
          </a>
        </article>
      </div>

      <div class="col-md-6 col-lg-4">
        <!-- card -->
        <article class="p-4 rounded shadow-sm border-left
       mb-4">
          <a class="open-bank d-flex align-items-center">
            <span class="bi bi-piggy-bank h1"></span>
            <h5 class="ml-2">My quizz bank</h5>
          </a>
        </article>
      </div>

    </section>

    <div class="jumbotron jumbotron-fluid rounded bg-white border-0 shadow-sm border-left px-4">
      <div class="container">
        <h1 class="display-4 mb-2 text-primary">My quizs</h1>

        <div id="loop-container">

        {% for Load_Quiz in Quiz %}

        <div class="myquiz">

         <div class="myquiz-title">
           <a target="_blank" href="https://quizzilo.vercel.app/quiz?session={{Load_Quiz.2}}">{{Load_Quiz.1}}</a>
         </div>

         <div class="myquiz-buttons">

          <button class="myquiz-button2" data-url="https://quizzilo.com/quiz?session=b'gAAAAABoPIbvLIe1O4eLVaxgCTtyB24hizUzL0BHH8W1jjrfg4gXN7sr7olmvS_04oKHN0o_ZAFd_ort8A714wKGldV4Dm_tRg=='">Share</button>

          <a href="editor?session={{Load_Quiz.0}}"> <button class="myquiz-button1"> Edit </button> </a>

         </div>

        </div>

        {%endfor%}

        </div>

      </div>
    </div>

  </main>
</div>

<div class="modal__container" id="modal-container">

  <div class="modal__content">

      <div class="main_modal">

      <h1 class="modal__title">New Quiz</h1>

      <p class="modal__description">Enter a title for your quiz.</p>

      {% csrf_token %}

      <input id="title_for_new_quizz"  class="modal__button modal__button-width" placeholder="e.g: Exam N 9">

      <button onclick="Create_New_Quizz()" class="modal__button modal__button-width_2" style="background-color: #007bff; color: white;  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19); margin: 10px;">
        Create
      </button>

      <button class="modal__button-link close-modal">
          Close
      </button>

      </div>

      <div style="display: none;" class="modal_loader">
        <div class="custom-loader-2"></div>
      </div>

  </div>

</div>

<!-- Sharing Modal -->
<div class="sharing-modal" id="sharing-modal">  <div class="sharing-modal-content">
    <div class="sharing-modal-header">
      <h2>Share Your Quiz Bank</h2>
      <span class="sharing-modal-close" onclick="closeSharingModal()">&times;</span>
    </div>

    <div class="sharing-modal-body">
      <div class="sharing-section">
        <h3>Select Path to Share</h3>
        <div class="path-selector">
          <div class="current-path-display">
            <span class="path-icon">üìÅ</span>
            <span id="selected-path-text">/</span>
            <button class="browse-path-btn" onclick="togglePathBrowser()">Browse</button>
          </div>

          <div class="path-browser" id="path-browser" style="display: none;">
            <div class="path-browser-header">
              <span>Select a folder to share:</span>
            </div>
            <div class="path-browser-content" id="path-browser-content">
              <!-- Path tree will be generated here -->
            </div>
          </div>
        </div>
      </div>

      <div class="sharing-section">
        <h3>Permissions</h3>
        <div class="permission-options">
          <label class="permission-option">
            <input type="radio" name="permission" value="view" checked>
            <span class="permission-icon">üëÅÔ∏è</span>
            <div class="permission-details">
              <strong>View Only</strong>
              <p>Recipients can browse and view files but cannot make changes</p>
            </div>
          </label>

          <label class="permission-option">
            <input type="radio" name="permission" value="edit">
            <span class="permission-icon">‚úèÔ∏è</span>
            <div class="permission-details">
              <strong>Edit Access</strong>
              <p>Recipients can browse, view, and modify files and folders</p>
            </div>
          </label>
        </div>
      </div>

          <!-- Lock Option -->
      <div class="sharing-section">
        <h3>Password Protection</h3>
        <input id="inpShareLock" type="checkbox" onclick="RestrictShare()"{% if has_share_password %} checked{% endif %}>
        <label class="btn-lock" for="inpShareLock" style="margin-bottom: 10px;">
            <svg width="36" height="40" style="margin-left: 7px;" viewBox="0 0 36 40">
                <path class="lockb" d="M27 27C27 34.1797 21.1797 40 14 40C6.8203 40 1 34.1797 1 27C1 19.8203 6.8203 14 14 14C21.1797 14 27 19.8203 27 27ZM15.6298 26.5191C16.4544 25.9845 17 25.056 17 24C17 22.3431 15.6569 21 14 21C12.3431 21 11 22.3431 11 24C11 25.056 11.5456 25.9845 12.3702 26.5191L11 32H17L15.6298 26.5191Z"></path>
                <path class="lock" d="M6 21V10C6 5.58172 9.58172 2 14 2V2C18.4183 2 22 5.58172 22 10V21"></path>
                <path class="bling" d="M29 20L31 22"></path>
                <path class="bling" d="M31.5 15H34.5"></path>
                <path class="bling" d="M29 10L31 8"></path>
            </svg>
        </label>
      </div>

      <div class="sharing-section">
        <h3>Share Link</h3>
        <div class="share-link-container">
          <input type="text" id="share-link-input" readonly placeholder="Click generate to create share link">
          <button class="copy-link-btn" onclick="copyShareLink(event)">Copy</button>
        </div>
      </div>
    </div>

    <div class="sharing-modal-footer">
      <button class="btn-generate" onclick="generateShareLink()">Generate Link</button>
      <button class="btn-cancel" onclick="closeSharingModal()">Cancel</button>
    </div>
  </div>
</div>

<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js'></script>

<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/create_quizz.js' %}"></script>

</body>

</html>
